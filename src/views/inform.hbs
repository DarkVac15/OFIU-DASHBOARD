<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFIU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400,300' rel='stylesheet' type='text/css'>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <!-- Enlazar Leaflet.js y Leaflet.heat -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-image/0.1.0/leaflet-image.min.js"></script>
</head>

<body>
    <div class=" mt-2">
        <div class="card p-4">
            <h2 class="mb-3">Fecha de generación: {{fechaActual}}</h2>
            <h3 class="mb-4"> Informe de Métricas de Uso de la Aplicación</h3>
            <p><strong>Período del informe:</strong> {{startDate}} - {{endDate}}</p>

            <section class="mb-5">
                <h2 class="section-title border-bottom border-primary pb-3 mb-4 text-dark">1. Métricas Generales</h2>
                <div class="row">
                    <!-- Primeras cuatro tarjetas en la primera fila -->
                    <div class="col-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="metric-value fs-1">{{totalUsers}}</div>
                                <div class="metric-label text-muted">Usuarios Registrados</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="metric-value fs-1">{{totalProfessionals}}</div>
                                <div class="metric-label text-muted">Profesionales Registrados</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="metric-value fs-1">{{totalDisabledUsers}}</div>
                                <div class="metric-label text-muted">Usuarios Inhabilitados</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="metric-value fs-1">{{totalTickets}}</div>
                                <div class="metric-label text-muted">Tickets <br> Creados</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quinta tarjeta en la segunda fila ocupando toda la fila -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Profesionales por ciudad</h5>
                                <ul class="list-group">
                                    {{#each filteredCityCountProfesional}}
                                    <li class="list-group-item">{{@key}}: {{this}} profesional</li>
                                    {{/each}}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>





            <h2 class="section-title border-bottom border-primary pb-3 mb-4 text-dark">2. Análisis de Tickets</h2>
            <div class="mb-4">

                <h3>Estado de los tickets</h3>
                <p>Gráfico de Barras mostrando el estado de los tickets</p>
                <div id="ticket-status-chart"></div> <!-- Lugar para el gráfico de barras -->
                <table class="table  table-bordered mt-3 ">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Número de Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each filteredStateCount}}
                        <tr>
                            <td>{{@key}}</td>
                            <td>{{this}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
                <h6 class="mt-4">Descripcion</h6>
                <ul cstyle="font-size: 0.6rem;">
                    <li>Abierto: El ticket está disponible en la plataforma y puede ser atendido por un profesional. Es
                        el
                        estado inicial, cuando el cliente crea un ticket y espera ser contactado. </li>
                    <li>Cerrado: El ticket ha sido atendido y el cliente ha concluido el trabajo con el profesional. El
                        estado "cerrado" indica que el servicio ha sido completado con éxito, pero el ticket sigue en la
                        plataforma para su revisión o posible retroalimentación.</li>
                    <li>Finalizado: El ticket ha sido eliminado por el cliente, lo que indica que el proceso ha
                        terminado
                        completamente. Este estado marca la eliminación del ticket de la plataforma, ya sea porque el
                        cliente no necesita más asistencia o porque el ticket ya no es relevante.</li>
                </ul>

            </div>

            <div class="mb-4">
                <h4>Tickets por Etiqueta</h4>
                <p>Gráfico de Barras con las etiquetas más frecuentes en tickets</p>
                <div id="ticket-tags-chart"></div> <!-- Lugar para el gráfico de etiquetas -->
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr>
                            <th>Etiqueta</th>
                            <th>Número de Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each data_etiquetas_ticket}}
                        <tr>
                            <td>{{@key}}</td>
                            <td>{{this}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <h2 class="section-title border-bottom border-primary pb-3 mb-4 text-dark">3. Análisis Geográfico: Mapa de
                Calor
            </h2>
            <div>
                <p><strong>Descripción:</strong> Muestra la distribución de tickets por ciudad</p>
                <div id="map"></div> <!-- Lugar para el mapa de calor -->

                <table class="table table-bordered mt-3">

                    <thead>
                        <tr>
                            <th>Ciudad</th>
                            <th>Número de Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each filteredLocationCountTicket}}
                        <tr>
                            <td>{{@key}}</td>
                            <td>{{this}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            <h2 class="section-title border-bottom border-primary pb-3 mb-4 text-dark">4. Gráficas de Línea (Tendencias)
            </h2>
            <div class="row">
                <div class="col-md-10">
                    <h4>Registro de Usuarios</h4>
                    <canvas id="userTrendChart" width="400" height="200"></canvas>
                </div>
                <div class="col-md-10">
                    <h4>Registro de Profesionales</h4>
                    <canvas id="professionalTrendChart" width="400" height="200"></canvas>
                </div>
                <div class="col-md-10">
                    <h4>Creación de Tickets</h4>
                    <canvas id="ticketTrendChart" width="400" height="200"></canvas>
                </div>
            </div>

            <h2 class="section-title border-bottom border-primary pb-3 mb-4 text-dark">5. Conclusiones</h2>
            <ul class="list-group">

                <li class="list-group-item">
                    <strong>Resumen de los Hallazgos:</strong>
                    <ul>
                        {{{formattedHallazgos}}}
                    </ul>
                </li>


                <li class="list-group-item">
                    <strong>Recomendaciones Generales:</strong>
                    <ul>
                        {{{formattedRecomendaciones}}}
                    </ul>
                </li>
                <li class="list-group-item">
                    <strong>Perspectivas Futuras:</strong>
                    <ul>
                        {{{formattedPerspectivasFuturas}}}
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <style>
        .report-container {
            max-width: 1200px;
            margin: auto;
        }

        .card {
            background-color: #f8f9fa;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h2,
        h3,
        h4,
        h5 {
            color: #343a40;
        }

        .table th,
        .table td {
            vertical-align: middle;
            text-align: center;
        }

        .table th {
            background-color: #f1f1f1;
        }

        #heatmap {
            height: 300px;
            background-color: #e9ecef;
            margin-bottom: 30px;
        }

        .list-group-item {
            background-color: #ffffff;
        }

        .mt-5 {
            margin-top: 3rem;
        }

        #map {
            width: 100%;
            height: 300px;
            /* Ajusta la altura según tus necesidades */
        }
    </style>

    <script>
        // Coordenadas de las ciudades
        const citiesCoordinates = {
            "Espinal": { lat: 4.14924, lng: -74.88429 },
            "Girardot": { lat: 4.30079, lng: -74.80754 },
            "Guamo": { lat: 4.03078, lng: -74.9701 },
            "Flandes": { lat: 4.29005, lng: -74.81612 }
        };

        // Ubicaciones de los trabajos (ciudades) y el número de trabajos en cada ciudad
        const locationData = {{{ locationChartLabels }}}; // Por ejemplo: ["El Espinal", "Ibagué", "Melgar"]
        const locationValues = {{{ locationChartData }}}; // Ejemplo: [10, 20, 15] (Número de trabajos por ciudad)

        // Crear el mapa de Leaflet, centrado en una ciudad por defecto (por ejemplo, El Espinal)
        // Crear el mapa de Leaflet, centrado en una ciudad por defecto (por ejemplo, El Espinal)
        const map = L.map('map').setView([4.22305, -74.83435], 11);

        // Añadir capa de OpenStreetMap al mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Asegúrate de que el mapa se ajusta a su contenedor después de cargar
        map.on('load', function () {
            map.invalidateSize();
        });

        // Agregar los círculos (burbujas) a cada ciudad en el mapa
        locationData.forEach((city, index) => {
            // Obtener las coordenadas de la ciudad usando el objeto `citiesCoordinates`
            const { lat, lng } = citiesCoordinates[city];
            const ticketCount = locationValues[index]; // Número de tickets en esa ciudad
            const circleSize = ticketCount * 2;
            // Crear un círculo (burbuja) para representar el número de tickets en la ciudad
            L.circleMarker([lat, lng], {
                radius: circleSize,  // Tamaño del círculo basado en el número de tickets
                color: 'blue',  // Color del borde del círculo
                fillColor: 'blue',  // Color de relleno
                fillOpacity: 0.6  // Opacidad del relleno
            }).addTo(map)
                .bindPopup(`${city}: ${ticketCount} Tickets`); // Mostrar el número de tickets en un popup al hacer clic
        });



        // Obtén el contexto del canvas
        const ctx = document.getElementById('ticketTrendChart').getContext('2d');

        // Crear el gráfico de línea
        const ticketTrendChart = new Chart(ctx, {
            type: 'line',  // Tipo de gráfico: línea
            data: {
                labels: JSON.parse('{{{ticketTrendLabels}}}'),  // Etiquetas para el eje X (fechas de tickets)
                datasets: [{
                    label: 'Tickets Creados',
                    data: JSON.parse('{{{ticketTrendData}}}'),  // Datos para el eje Y (cantidad de tickets)
                    fill: false,  // No llenar el área bajo la línea
                    borderColor: 'rgba(54, 162, 235, 1)',  // Color de la línea
                    tension: 0.1,  // Suavizar la curva de la línea
                }]
            },
            options: {
                responsive: true,  // Ajuste responsivo
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'  // Título del eje X
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Número de Tickets'  // Título del eje Y
                        }
                    }
                }
            }
        });



        const ctxProfessionalTrend = document.getElementById('professionalTrendChart').getContext('2d');
        const professionalTrendChart = new Chart(ctxProfessionalTrend, {
            type: 'line',
            data: {
                labels: JSON.parse('{{{professionalTrendLabels}}}'),
                datasets: [{
                    label: 'Profesionales Registrados',
                    data: JSON.parse('{{{professionalTrendData}}}'),
                    borderColor: 'rgba(54, 162, 235, 1)', // Color azul para el borde
                    backgroundColor: 'rgba(54, 162, 235, 0.2)', // Fondo azul claro
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Número de Profesionales'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        const ctxUserTrend = document.getElementById('userTrendChart').getContext('2d');
        const userTrendChart = new Chart(ctxUserTrend, {
            type: 'line',
            data: {
                labels: {{{ userTrendLabels }}},
        datasets: [{
            label: 'Usuarios Registrados',
            data: {{{ userTrendData }}},
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            borderWidth: 2
            }]
        },
        options: {
            responsive: true,
                scales: {
                x: {
                    title: {
                        display: true,
                            text: 'Fecha'
                    }
                },
                y: {
                    title: {
                        display: true,
                            text: 'Número de Usuarios'
                    },
                    beginAtZero: true // Para que el gráfico comience en cero
                }
            }
        }
    });



        function printPage() {
            window.print();
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</body>

</html>